{"version":3,"names":["emCalibratorCss","EmCalibrator","handleSelectedRange","this","processFile","adjustmentValue","range","getLayers","originalGcode","then","layers","result","generateResult","newLayers","layerCount","layer","newLayer","generateNewLayer","push","join","lines","split","newLines","minX","getMinX","maxX","getMaxX","previousX","forEach","line","adjustedLine","adjustLine","currentX","extractXValue","isExtrusionLine","averageX","ratio","eAdjustment","applyEAdjustment","eValueMatch","match","originalEValue","parseFloat","adjustedEValue","newLine","replace","toFixed","startsWith","includes","x","getX","Number","getExtrusion","extrusion","Promise","resolve","reject","reader","FileReader","onload","e","target","readAsText","setMinmm","value","minmm","isNaN","minEm","getEmForMm","setMaxmm","maxmm","maxEm","mm","render","h","Host","href","getAssetPath","type","id","name","accept","onChange","files","parseInt","encodeURIComponent","download","onClick","showInstructions","class","step","min","max","onInput","_a"],"sources":["src/components/em-calibrator/em-calibrator.css?tag=em-calibrator&encapsulation=shadow","src/components/em-calibrator/em-calibrator.tsx"],"sourcesContent":[":host {\n  display: block;\n}\n\n.form{\n  display: grid;\n  gap: 1rem;\n  grid-template-columns: 1fr 1fr;\n}\n","import { Component, Host, getAssetPath, h, State } from '@stencil/core';\n\n@Component({\n  tag: 'em-calibrator',\n  styleUrl: 'em-calibrator.css',\n  shadow: true,\n  assetsDirs: ['assets'],\n})\nexport class EmCalibrator {\n\n  @State() originalGcode: File;\n  @State() result: string;\n  @State() adjustmentValue: number;\n  @State() showInstructions: boolean;\n  @State() minmm: number;\n  @State() maxmm: number;\n  @State() minEm: number;\n  @State() maxEm: number;\n\n  handleSelectedRange(): void {\n    this.processFile(this.adjustmentValue);\n  }\n\n  processFile(range: number) {\n    this.getLayers(this.originalGcode)\n    .then(layers => {\n        this.result = this.generateResult(layers, range);\n      });\n  }\n\n  generateResult(layers: string[], range: number): string {\n    var newLayers: string[] = [];\n    var layerCount = 0;\n    for (var layer of layers) {\n      if (layerCount > 1) {\n        var newLayer = this.generateNewLayer(layer, range);\n        newLayers.push(newLayer);\n      }\n      else {\n        newLayers.push(layer);\n      }\n      layerCount++;\n    }\n    return newLayers.join(\"\\n\");\n  }\n\n  generateNewLayer(layer: string, range: number): string {\n    const lines = layer.split(\"\\n\");\n    const newLines: string[] = [];\n    const minX = this.getMinX(layer);\n    const maxX = this.getMaxX(layer);\n    let previousX: number | null = null;\n\n    lines.forEach(line => {\n      const adjustedLine = this.adjustLine(line, minX, maxX, range, previousX);\n      newLines.push(adjustedLine);\n\n      const currentX = this.extractXValue(line);\n      if (currentX !== null) {\n          previousX = currentX;\n      }\n    })\n\n    return newLines.join(\"\\n\");\n  }\n\n  adjustLine(line: string, minX: number, maxX: number, range: number, previousX: number): string {\n    if (!this.isExtrusionLine(line)){\n      return line;\n    }\n\n    const currentX = this.extractXValue(line);\n    if (currentX !== null && previousX !== null) {\n        const averageX = (currentX + previousX) / 2;\n        const ratio = (averageX - minX) / (maxX - minX);\n        const eAdjustment = 1 + (range / 100) * (2 * ratio - 1);\n\n        // Apply the adjustment to the E value\n        return this.applyEAdjustment(line, eAdjustment);\n    }\n\n      return line;\n  }\n\n  applyEAdjustment(line: string, eAdjustment: number): string {\n    const eValueMatch = line.match(/E(-?\\d+(\\.\\d+)?)/);\n    if (eValueMatch && eValueMatch[1]) {\n        const originalEValue = parseFloat(eValueMatch[1]);\n        const adjustedEValue = originalEValue * eAdjustment;\n        const newLine = line.replace(/E-?\\d+(\\.\\d+)?/, `E${adjustedEValue.toFixed(5)}`);\n        return `${newLine} ; E adjustment: ${eAdjustment}`\n    }\n\n    return line;\n  }\n\n  extractXValue(line: string) {\n    const match = line.match(/X(\\d+\\.\\d+)/);\n    if (match) {\n        return parseFloat(match[1]);\n    }\n    return null;\n  }\n  \n  isExtrusionLine(line: string) {\n    return line.startsWith(\"G1\") && line.includes(\"E\");\n  }\n\n  getMinX(layer: string) {\n    var minX = 100000;\n    var lines = layer.split(\"\\n\");\n    for (var line of lines) {\n\n      var x = this.getX(line);\n      if (x && x < minX) {\n        minX = x;\n      }\n    }\n    return minX;\n  }\n\n  getMaxX(layer: string) {\n    var maxX = -100000;\n    var lines = layer.split(\"\\n\");\n    for (var line of lines) {\n      var x = this.getX(line);\n      if (x && x > maxX) {\n        maxX = x;\n      }\n    }\n    return maxX;\n  }\n  \n  getX(line: string): number {\n    if (line.startsWith(\";\")) {\n      return null;\n    }\n\n    if (!line.startsWith(\"G1\")) {\n      return null;\n    }\n\n    var match = line.match(/X(-?\\d+(\\.\\d+)?)/);\n    if (match && match[1]) {\n      return Number.parseFloat(match[1]);\n    }\n    return null;\n  }\n\n  getExtrusion(line: string) {\n    var extrusion = line.match(/E\\d+\\.\\d+/);\n    if (extrusion) {\n      return extrusion[0];\n    }\n    return null;\n  }\n\n  async getLayers(originalGcode: File): Promise<string[]> {\n    return new Promise((resolve, reject) => {\n      var reader = new FileReader();\n      reader.onload = (e) => {\n        var lines = (e.target as any).result.split('\\n');\n        var layers = [];\n        var layer = \"\";\n        for (var line of lines) {\n          if (line.startsWith(\";LAYER\")) {\n            if (layer != \"\") {\n              layers.push(layer);\n            }\n            layer = \"\";\n          }\n          layer += line + \"\\n\";\n        }\n\n        // After the loop, push the last layer if it is not empty\n        if (layer != \"\") {\n          layers.push(layer);\n        }\n\n        resolve(layers);\n      }\n      try {\n        reader.readAsText(originalGcode);\n      }\n      catch (e) {\n        reject(e);\n      }\n    });\n  }\n\n  private setMinmm(value: string): void {\n    const minmm = Number.parseFloat(value);\n    if (!isNaN(minmm)){\n      this.minmm = minmm;\n      var minEm = this.getEmForMm(minmm);\n      this.minEm = parseFloat(minEm.toFixed(5));\n    }\n  }\n  \n  setMaxmm(value: string): void {\n    const maxmm = Number.parseFloat(value);\n    if (!isNaN(maxmm)){\n      this.maxmm = maxmm;\n      var maxEm = this.getEmForMm(maxmm);\n      this.maxEm = parseFloat(maxEm.toFixed(5));\n    }\n  }\n\n  getEmForMm(mm: number) {\n    return 1 + (this.adjustmentValue / 100) * (2 * mm / 100 - 1);\n  }\n\n  render() {\n    return (\n      <Host>\n        <h1>EM Calibrator</h1>\n        <fieldset>\n          <legend>Download and slice</legend>\n          <p>Start by downloading <a href={getAssetPath(\"./assets/em.stl\")}>this model</a> and slice it with your slicer of choice.</p>\n          <p>Use your normal print settings but ensure that:</p>\n          <ul>\n            <li>Your infill is at 45 degrees from the rectangle.</li>\n            <li>You have at least 2 layers of sparse infill to decouple the top layers from any first layer issues.</li>\n          </ul>\n        </fieldset>\n\n        <fieldset>\n          <legend>Upload your gcode</legend>\n          <p>Upload your gcode file here:</p>\n          <input\n            type=\"file\"\n            id=\"gcode\"\n            name=\"gcode\"\n            accept=\".gcode\"\n            onChange={(e) => this.originalGcode = (e.target as HTMLInputElement).files[0]}\n          />\n        </fieldset>\n\n        {this.originalGcode && \n          <fieldset>\n            <legend>Settings</legend>\n            <label>Extrusion Multiplier Range: </label>\n            <select\n              onChange={(e) => {\n                this.adjustmentValue = parseInt((e.target as HTMLSelectElement).value);\n                return this.handleSelectedRange();\n              }}\n            >\n              <option value=\"\">-- Select an option --</option>\n              <option value={50}>+- 50%</option>\n              <option value={20}>+- 20%</option>\n              <option value={10}>+- 10%</option>\n              <option value={5}>+- 5%</option>\n              <option value={2}>+- 2%</option>\n              <option value={1}>+- 1%</option>\n            </select>\n            <br />\n\n          </fieldset>\n        }\n        {this.result &&\n          <fieldset>\n            <legend>Download And Print</legend>\n            <p>Download the result &nbsp;\n              <a\n                href={`data:text/plain;charset=utf-8,${encodeURIComponent(this.result)}`}\n                download={`em-calibrated${this.adjustmentValue}.gcode`}\n                onClick={() => this.showInstructions = true}\n              >\n                here\n              </a>\n            .</p>\n          </fieldset>\n        }\n        {this.showInstructions &&\n          <fieldset>\n            <legend>Instructions</legend>\n            <p>Print the downloaded file.</p>\n            <p>Bend and twist and stretch the striped band lightly.</p>\n            <p>\n              Measure milimeters from the left (-) side to where the band did not property separate.\n              This is the <strong>Maximum</strong> EM you could use and still be able to print with 0.1 or 0.2 tolerances.\n              <em>\n                One side has all 0.1mm clearances and the other side all 0.2mm clearances.\n                If one side completelly does not come apart, you either need to do an extruder calibration \n                or your printer is not precise enough for 0.1mm tolerances.\n              </em>\n            </p>\n            <p>For the 100mm x 50mm rectangle, measure how many mm from the left (-) side look underextruded, this is your <string>Minimum</string> EM you can set.</p>\n            <fieldset>\n              <legend>Calculations</legend>\n              <div class=\"form\">\n                <label>Minimum mm: </label>\n                <input type=\"range\" step={1} min={0} max={100} value={this.minmm} onInput={e => this.setMinmm((e.target as HTMLInputElement).value)}/>\n                <label>Minimum mm: </label>\n                <span>{this.minmm}</span>\n                <label>Minimum EM: </label>\n                <span>{this.minEm}</span>\n                <label>Maximum mm: </label>\n                <input type=\"number\" value={this.maxmm} onInput={e =>this.setMaxmm((e.target as HTMLInputElement).value)}/>\n                <label>Maximum EM: </label>\n                <span>{this.maxEm}</span>\n                <label>Average EM: </label>\n                <span>{(this.minEm + this.maxEm)/2}</span>\n                <label>EM range: </label>\n                <span>{(this.minEm && this.maxEm && ((this.maxEm - this.minEm) / ((this.minEm + this.maxEm) / 2) * 100)/2)?.toFixed(5)}</span>\n              </div>\n            </fieldset>\n          </fieldset>\n        }\n      </Host>\n    );\n  }\n}\n"],"mappings":"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"}